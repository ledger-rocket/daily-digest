name: Daily Narrative Digest
on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:
jobs:
  daily-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.DIGEST_APP_ID }}
          private-key: ${{ secrets.DIGEST_APP_PRIVATE_KEY }}
          owner: ${{ vars.DIGEST_GH_ORG }}
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Set up uv
        uses: astral-sh/setup-uv@v4
      - name: Install dependencies
        run: uv sync --no-dev
      - name: Run digest
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          DIGEST_GH_ORG: ${{ vars.DIGEST_GH_ORG }}
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: uv run python scripts/digest.py
